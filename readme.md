# General Task Launcher (Python Edition)

Version: 2026/01/23
Environment: Python 3.11.9

# 目的

このツールは、**CSVファイルに定義されたタスクを定期的に実行する自動化ランチャ**です。
従来のPowerShell版からPython版へ移行し、多重起動防止機能やデータ整合性チェックなどの堅牢性を強化しました。

## 概要

* `scheduler.py`: メインプログラム。CSVファイルを定期監視し、定義されたプロセスを自動実行します。
* `threading` を利用した並列実行に対応し、一つのタスクが遅延しても全体のスケジュールに影響を与えません。
* ソケット通信を利用した**多重起動防止機能**を実装しています。

## ファイル構成

| ファイル名 | 説明 |
| --------- | ---- |
| `scheduler.py` | メインのスケジューラスクリプト。 |
| `process_schedule.csv` | タスク定義ファイル。実行するプロセスと頻度を管理します。 |
| `task_log.log` | 実行ログファイル。 |
| `startup.bat` | **(新規)** スケジューラ起動用バッチファイル。 |
| `readme.md` | 本ファイル。 |

## 主な機能と変更点

### 1. 多重起動防止 (Single Instance Lock)
Pythonの `socket` モジュールを使用し、特定のローカルポート（デフォルト: 62000）をロックすることで、同一スクリプトの多重起動を防止しています。
誤って複数回 `startup.bat` を実行しても、2つ目以降のプロセスは自動的に終了します。

### 2. 事前検証と整合性チェック
タスク実行前に以下の検証を行い、問題がある場合は実行をスキップしてログに警告を出力します。
* **データ型チェック**: 実行頻度（Frequency）が数値であるか。
* **ファイル存在確認**: 指定された実行ファイルが実在するか。

### 3. 並列処理
`concurrent.futures` を採用しており、重い処理が走ってもスケジューラ自体の監視ループは停止しません。

## CSVファイルフォーマット

`process_schedule.csv` の仕様はPowerShell版と互換性があります。

| 列名 | 説明 | 例 | 必須 |
| ---- | ---- | ---- | --- |
| Enabled | 有効フラグ (true/false) | true | Yes |
| ProcessName | タスク識別名 | DailyBackup | Yes |
| ExecutablePath | 実行ファイルのパス | scripts/backup.py | Yes |
| Arguments | コマンドライン引数 | --silent | No |
| Frequency | 実行間隔（分単位） | 1440 | Yes |
| LastRunTime | 最終実行時刻（自動更新） | 2026-01-23 09:00:00 | No |

## 使用方法

### 1. CSVファイルの準備

`process_schedule.csv` を以下のような形式で作成します：

```csv
Enabled,ProcessName,ExecutablePath,Arguments,Frequency,LastRunTime
true,PyTask,scripts/myscript.py,--verbose,60,
true,BatTask,C:\Tools\cleanup.bat,,1440,

```

### 2. 起動用バッチファイルの作成 (startup.bat)

Pythonスクリプトをバックグラウンド（または最小化）で起動するために、以下の内容で `startup.bat` を作成してください。
環境変数の `python` コマンドが通っていることを前提としています。

```batch
@echo off
cd /d %~dp0

:: 最小化で実行する場合
start /min python scheduler.py

:: 完全にバックグラウンドで実行する場合（pythonwを使用）
:: start "" pythonw scheduler.py

```

### 3. 実行

作成した `startup.bat` をダブルクリックして実行します。
初回起動時はタスクが即座に実行され（LastRunTimeが空の場合）、以降は指定間隔で実行されます。

## 対応ファイル形式

拡張子に応じて自動的に実行方法を切り替えます。

* `.py` : 現在のPython環境 (`sys.executable`) で実行
* `.ps1` : `powershell -ExecutionPolicy Bypass -File ...` で実行
* `.bat` / `.cmd` : `cmd.exe /c ...` で実行
* `.exe` : 直接実行

## トラブルシューティング

* **ログの確認**: 動作状況はすべて `task_log.log` に出力されます。
* **「ALREADY RUNNING」エラー**: 既にスクリプトが起動しています。タスクマネージャーから `python.exe` (または `pythonw.exe`) を確認してください。
* **ソケットエラー**: 別のアプリケーションがポート62000を使用している場合、ソースコード内の `LOCK_PORT` を変更してください。

## 推奨されるタスク登録と活用例

本ツールの特性（常駐監視、並列実行、多様なスクリプト実行）を活かした、効果的なタスク登録のアイデアを以下にまとめました。

### 1. 開発環境の自動化
定期的なコード同期やビルドを行うことで、常に最新の状態を保ちます。

| タスク名 | 頻度(分) | 実行内容 | メリット |
| :--- | :---: | :--- | :--- |
| **SVN/Git Update** | 60 | `svn update` や `git pull` | チーム開発でのコードの競合を早期に検知・解消できます。 |
| **Dependency Install** | 1440 (1日) | `pip install` 等 | ライブラリの更新忘れを防ぎます。 |

### 2. システムメンテナンス
PCやサーバーの健全性を保つためのタスクです。

| タスク名 | 頻度(分) | 実行内容 | メリット |
| :--- | :---: | :--- | :--- |
| **Log Cleanup** | 10080 (1週) | 古いログファイルの削除・圧縮 | ディスク容量の圧迫を防ぎます。 |
| **Temp File Clear** | 1440 (1日) | 一時フォルダの掃除 | 不要なゴミファイルの蓄積を防ぎます。 |
| **App Keep-Alive** | 5 | 常駐アプリのプロセス監視・再起動 | 重要なアプリが落ちていた場合に自動復旧させます。 |

### 3. バックアップ
万が一の事態に備えたデータ保全です。

| タスク名 | 頻度(分) | 実行内容 | メリット |
| :--- | :---: | :--- | :--- |
| **Project Backup** | 360 (6時間) | 作業フォルダのコピー/Zip化 | 作業ミスによるデータ消失リスクを軽減します。 |
| **DB Dump** | 1440 (1日) | データベースのダンプ出力 | データの復元ポイントを確保します。 |

### 4. 通知・リマインダー
定型業務の抜け漏れを防ぎます。

| タスク名 | 頻度(分) | 実行内容 | メリット |
| :--- | :---: | :--- | :--- |
| **Daily Report** | 1440 | 日報作成スクリプトの起動 | 日報の書き忘れ防止やテンプレート作成を自動化。 |
| **Cloud Sync** | 60 | クラウドストレージへの同期 | 重要なデータをクラウドへ退避。 |

### 5. 開発・実行環境の健全化 (New!)
長期運用において、環境のゴミや異常を検知・排除するタスクです。

| タスク名 | 頻度(分) | 実行内容 | メリット |
| :--- | :---: | :--- | :--- |
| **Clean PyCache** | 10080 (1週) | `__pycache__` 削除 | 古いコンパイル済みファイルによる挙動不審（コード変更が反映されない等）を予防します。 |
| **Disk Monitor** | 60 | ディスク容量チェック | 空き容量が閾値を下回った場合にログ出力やアラートを行い、システム停止を防ぎます。 |
| **Network Check** | 15 | Ping監視 | ネットワーク断を検知し、ログに残すことでトラブルシューティングを容易にします。 |

## タスク設定のベストプラクティス

* **パスは絶対パスで**: `ExecutablePath` は可能な限り絶対パス（例: `C:\Scripts\backup.bat`）で記述してください。相対パスは実行時のカレントディレクトリに依存するため、予期せぬエラーの原因になります。
* **頻度（Frequency）の設定**: 処理に掛かる時間よりも短い間隔を設定すると、プロセスが重複して実行される可能性があります（本ツールは並列実行可能なため）。処理時間 + 余裕を持った間隔を設定してください。
* **ログの活用**: 実行するスクリプト側でも標準出力（stdout/stderr）を行うことで、本ツールの `task_log.log` に結果が記録され、後から成否を確認しやすくなります。

---
